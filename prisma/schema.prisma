generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String            @id @default(uuid())
  email            String            @unique
  password         String
  name             String?
  posts            Post[]
  linkedinAccounts LinkedinAccount[]
  schedules        Schedule[]
  profile          UserProfile?
  savedJobs        SavedJob[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model LinkedinAccount {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  linkedinId   String   @unique
  accessToken  String
  refreshToken String?
  expiresAt    DateTime
  name         String?
  email        String?
  profileUrl   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model Post {
  id             String    @id @default(uuid())
  content        String
  category       String
  scheduledAt    DateTime?
  status         String    @default("draft")
  publishedAt    DateTime?
  linkedinPostId String?
  scheduleId     String?
  schedule       Schedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([scheduledAt])
  @@index([scheduleId])
}

model Schedule {
  id          String    @id @default(uuid())
  name        String
  description String?
  frequency   String
  interval    Int       @default(1)
  categories  String[]
  isActive    Boolean   @default(true)
  lastRunAt   DateTime?
  nextRunAt   DateTime
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  posts       Post[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([isActive])
  @@index([nextRunAt])
}

model UserProfile {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ── LinkedIn / manual bio ──────────────────────────────────
  linkedinBio    String?

  // ── CV file storage ────────────────────────────────────────
  cvS3Key        String?
  cvFileName     String?
  cvMimeType     String?
  cvEditableText String?  // extracted/editable full CV text

  // ── AI-extracted personal info ─────────────────────────────
  fullName       String?
  email          String?
  phone          String?
  location       String?
  jobTitle       String?

  // ── AI-extracted profile data ──────────────────────────────
  profileSummary String?
  skills         String[]
  certifications String[]
  languages      String[]

  // ── AI-extracted structured sections (stored as JSON) ─────
  experience     Json?    // [{ title, company, duration, description }]
  education      Json?    // [{ degree, institution, year }]

  // ── CV quality scoring ─────────────────────────────────────
  cvScore        Int?
  cvFeedback     String[] // array of improvement tips

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model SavedJob {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  externalId String
  title      String
  company    String
  location   String?
  description String
  url        String
  salary     String?
  platform   String   @default("adzuna")
  createdAt  DateTime @default(now())

  @@unique([userId, externalId])
  @@index([userId])
}
